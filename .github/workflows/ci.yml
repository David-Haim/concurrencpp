name: Continuous Integration

on:
  push:
    branches:
      - master
      - develop

  pull_request:
    branches:
      - master
      - develop

  workflow_dispatch: ~

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  NINJA_STATUS: '[%f/%t %o/sec] '

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      tests-matrix: ${{ steps.script.outputs.matrix }}
    steps:
      - id: script
        shell: pwsh
        run: |
          $configs = @()

          foreach ($os in @("macos-11", "macos-12")) {
            $configs += @{
              "os" = $os
              "stdlib" = "libc++"
              "tsan" = $False
            }
          }

          foreach ($version in @(11, 12, 13)) {
            $configs += @{
              "clang-version" = $version
              "os" = "ubuntu-20.04"
              "stdlib" = "libc++"
              "tsan" = $False
            }
          }

          foreach ($version in @(2019, 2022)) {
            $configs += @{
              "msvc-version" = $version
              "os" = "windows-${version}"
              "stdlib" = "msvc-stl"
              "tsan" = $False
            }
          }

          foreach ($version in @(14, 15)) {
            foreach ($os in @("windows-2022", "ubuntu-22.04")) {
              $stdlibs = if ($os -eq "windows-2022") {
                @("msvc-stl")
              } else {
                @("libc++", "libstdc++")
              }
              foreach ($stdlib in $stdlibs) {
                if ($stdlib -eq "libstdc++") {
                  foreach ($libstdcxxVersion in $(11, 12)) {
                    $configs += @{
                      "clang-version" = $version
                      "libstdcxx-version" = $libstdcxxVersion
                      "os" = $os
                      "stdlib" = $stdlib
                      "tsan" = $os -eq "ubuntu-22.04" -and $version -eq 15 -and $libstdcxxVersion -eq 12
                    }
                  }
                } else {
                  $configs += @{
                    "clang-version" = $version
                    "os" = $os
                    "stdlib" = $stdlib
                    "tsan" = $os -eq "ubuntu-22.04" -and $version -eq 15
                  }
                }
              }
            }
          }

          $newConfigs = @()
          foreach ($config in $configs) {
            foreach ($shared in @($False, $True)) {
              $newConfig = $config.PsObject.Copy()
              $newConfig.shared = $shared
              $newConfigs += $newConfig
            }
          }
          $configs = $newConfigs

          Add-Content "${env:GITHUB_OUTPUT}" "matrix=$(ConvertTo-Json $configs -Compress)"

  tests:
    needs: build-matrix
    strategy:
      fail-fast: false
      matrix:
        include:
          ${{ fromJSON(needs.build-matrix.outputs.tests-matrix) }}
    name: >
      ${{ (matrix.clang-version && format('clang {0}', matrix.clang-version))
       || (matrix.msvc-version && format('msvc {0}', matrix.msvc-version))
       || 'apple-clang' }}
      ${{ ((matrix.clang-version || startsWith(matrix.os, 'macos')) && format('on {0}', matrix.os)) || '' }}
      ${{ (
        matrix.clang-version && startsWith(matrix.os, 'ubuntu')
        && (
          (matrix.libstdcxx-version && format('with {0}-{1}', matrix.stdlib, matrix.libstdcxx-version))
          || format('with {0}', matrix.stdlib)
        )) || '' }}
      and shared=${{ matrix.shared }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3

      - uses: friendlyanon/fetch-core-count@v1
        id: cores

      - shell: pwsh
        run: New-Item build/tools -ItemType Directory -ErrorAction SilentlyContinue

      - shell: sudo pwsh -File {0}
        run: |
          Add-Content -Value 'Acquire::Retries "100";' -Path /etc/apt/apt.conf.d/99-custom
          Add-Content -Value 'Acquire::https::Timeout "240";' -Path /etc/apt/apt.conf.d/99-custom
          Add-Content -Value 'Acquire::http::Timeout "240";' -Path /etc/apt/apt.conf.d/99-custom
          Add-Content -Value 'APT::Get::Assume-Yes "true";' -Path /etc/apt/apt.conf.d/99-custom
          Add-Content -Value 'APT::Install-Recommends "false";' -Path /etc/apt/apt.conf.d/99-custom
          Add-Content -Value 'APT::Install-Suggests "false";' -Path /etc/apt/apt.conf.d/99-custom
        if: ${{ startsWith(matrix.os, 'ubuntu') }}

      - uses: ./.github/actions/fetch-cmake
        id: cmake
        with:
          base-directory: build/tools

      - uses: ./.github/actions/fetch-ninja
        id: ninja
        with:
          base-directory: build/tools

      - uses: ./.github/actions/fetch-libstdc++
        id: libstdcxx
        with:
          version: ${{ matrix.libstdcxx-version }}
        if: ${{ matrix.stdlib == 'libstdc++' }}

      - uses: ./.github/actions/fetch-clang
        id: clang
        with:
          version: ${{ matrix.clang-version }}
          base-directory: build/tools
        if: ${{ matrix.clang-version }}

      - name: Build Examples
        uses: ./.github/actions/cmake-build
        continue-on-error: ${{ matrix.os == 'macos-11' }}
        env:
          CXX: ${{ steps.clang.outputs.clangxx }}
        with:
          cmake: ${{ steps.cmake.outputs.cmake }}
          ninja: ${{ steps.ninja.outputs.ninja }}
          jobs: ${{ steps.cores.outputs.plus_one }}
          source: example
          build: build/example
          args: >
            -DBUILD_SHARED_LIBS=${{ matrix.shared }}
            ${{ ( matrix.stdlib == 'libc++' && '-DCMAKE_CXX_FLAGS=-stdlib=libc++' ) || '' }}

      - name: Build Tests
        id: build_tests
        uses: ./.github/actions/cmake-build
        continue-on-error: ${{ matrix.os == 'macos-11' }}
        env:
          CXX: ${{ steps.clang.outputs.clangxx }}
        with:
          cmake: ${{ steps.cmake.outputs.cmake }}
          ninja: ${{ steps.ninja.outputs.ninja }}
          jobs: ${{ steps.cores.outputs.plus_one }}
          source: test
          build: build/test
          args: >
            -DBUILD_SHARED_LIBS=${{ matrix.shared }}
            -DENABLE_THREAD_SANITIZER=${{ matrix.tsan }}
            ${{ ( matrix.stdlib == 'libc++' && '-DCMAKE_CXX_FLAGS=-stdlib=libc++' ) || '' }}

      - uses: ./.github/actions/run-tests
        continue-on-error: ${{ startsWith(matrix.os, 'macos') }}
        if: steps.build_tests.outcome == 'success'
        with:
          ctest: ${{ steps.cmake.outputs.ctest }}
          jobs: ${{ steps.cores.outputs.plus_one }}
          test-dir: build/test
